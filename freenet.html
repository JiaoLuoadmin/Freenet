<!DOCTYPE html>

<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<title>Campo de Afinidades Ubícuoas</title>
    <script type="text/javascript" src="/Users/thiago/Dev/d3.v3/d3.v3.js"></script>
    <style type="text/css">
    	#graph, #stream, #info, #stream-message {
        	background-color: #DDDDDD;
        	border-width: 1px;
    	}
        circle.node{
            stroke-width: 1px;
            stroke: black;
            fill: black;
        }
        circle.selectedNet, circle.selectedPrototype{
        	stroke-width: 5px;
            stroke: black;
            fill: none;
        }
        text.node{
            font-family: sans-serif;
            font-size: 15px;
            text-anchor: middle;
            alignment-baseline: central;
            fill: white;
        }
        line.node{
            stroke-width: 5px;
            stroke: black;
        }
        #graph{
        	width: 74%;
        	float: left;
        	border-color: black;
        	border-style: solid;
        	border-width: 0px;
        	border-top-width: 1px;
        }
        #stream{
        	width: 24%;
        	margin-left: 0px;
        	float: left;
        	border-color: black;
        	border-style: solid;
        	border-width: 0px;
        	border-left-width: 1px;
        }
        #info{
        	width: 74%;
        	float: left;
        	border-color: black;
        	border-style: solid;
        }
        #stream-messages{
        	width: 100%;
        }
        #stream-message{
        	padding-left: 8px;
        	padding-right: 8px;
        	padding-top: 10px;
        	padding-bottom: 10px;
        	font-size: 12pt;
        	font-weight: normal;
        	border-bottom-color: #E0E0E0;
        	border-bottom-width: 1px;
        	border-bottom-style: solid;
        }
        #stream-footer{
        	text-align: center;
        	border-bottom-right-radius: 8px;
        	border-bottom-left-radius: 8px;
        }
    </style>
</head>
<body style="background-color: #FFFFFF">
    <div id="graph"></div>
    <div id="stream">
        <div id="stream-messages"></div>
        <div id="stream-footer"></div>
    </div>

    <script type="text/javascript">

	var nets = [{name: "MOLAA",
				location: "Los Angeles, CA",
				description: "MOLAA blah blah blah",
				image: "http://i.imgur.com/OV5JNjB.jpg",
				active: true,
				_prots: [{name: "AST",
						description: "ohh lalalala",
						image: "http://i.imgur.com/OV5JNjB.jpg"},
    					{name: "CAU",
    					description: "ohh lalalala",
						image: "http://i.imgur.com/OV5JNjB.jpg"},
			    		{name: "ISO",
			    		description: "ohh lalalala",
						image: "http://i.imgur.com/OV5JNjB.jpg"},
			    		{name: "VLE",
			    		description: "ohh lalalala",
						image: "http://i.imgur.com/OV5JNjB.jpg"}]
				},
				{name: "SESC",
				location: "São Paulo, SP",
				description: "SP blah blah blah",
				image: "http://i.imgur.com/OV5JNjB.jpg",
				active: true,
				_prots: [{name: "AST",
						description: "ohh lalalala",
						image: "http://i.imgur.com/OV5JNjB.jpg"},
			    		{name: "ISO",
			    		description: "ohh lalalala",
						image: "http://i.imgur.com/OV5JNjB.jpg"}]
				},
				{name: "542",
				location: "Oakland, CA",
				description: "542 blah blah blah",
				image: "http://i.imgur.com/OV5JNjB.jpg",
				active: false,
				_prots: [{name: "AST",
						description: "ohh lalalala",
						image: "http://i.imgur.com/OV5JNjB.jpg"},
    					{name: "CAU",
    					description: "ohh lalalala",
						image: "http://i.imgur.com/OV5JNjB.jpg"},
			    		{name: "ISO",
			    		description: "ohh lalalala",
						image: "http://i.imgur.com/OV5JNjB.jpg"},
			    		{name: "VLE",
			    		description: "ohh lalalala",
						image: "http://i.imgur.com/OV5JNjB.jpg"}]
				}];

	var msgs = [{datetime:"2013-04-12 12:12:32",
				 text:"hello",
				 receiver:"sms"},
				 {datetime:"2013-05-04 01:34:55",
				 text:"no man. this is a longer message to see what would happen with 140 characters, but it’s hard for me to write that much. We’ll never know.",
				 receiver:"twitter"},
				 {datetime:"2013-06-24 11:44:02",
				 text:"make some noise",
				 receiver:"twitter"},
				 {datetime:"2013-07-04 13:04:15",
				 text:"unbelibubble",
				 receiver:"sms"}];

	var nodes = [],
		links = [];

	var selectedNet = null,
		selectedPrototype = null;

	updateNodeAndLinkArrays();

    var graphSVG = d3.select("#graph")
        .append("svg")
        .attr("width", document.getElementById("graph").offsetWidth)
        .attr("height", 500);

	d3.select("#stream")
		.style("height",document.getElementById("graph").offsetHeight-2+"px");

	d3.select("#stream-footer").insert("img")
		.attr("src","http://i.imgur.com/wbExTgx.png")
		.attr("height","100px");

    var stream = d3.select("#stream-messages");
    stream.selectAll("div")
    	.data(msgs)
    	.enter().append("div")
    	.attr("id","stream-message")
    	.text(function(d){return d.text;});

	updateGraphSVG();

    var theForce = d3.layout.force();

	theForce.nodes(nodes)
		.links(links)
		.linkDistance(200)
		.charge(-800)
		.size([graphSVG.attr("width"),graphSVG.attr("height")])
		.on("tick",tick)
		.start();

	window.onresize = function(event) {
		graphSVG.attr("width",document.getElementById("graph").offsetWidth);
		theForce.size([graphSVG.attr("width"),graphSVG.attr("height")]).start();
	};

	function tick(){
		graphSVG.selectAll("line.node")
			.attr("x1", function(d){return d.source.x;})
			.attr("y1", function(d){return d.source.y;})
			.attr("x2", function(d){return d.target.x;})
			.attr("y2", function(d){return d.target.y;});
		graphSVG.selectAll("circle.node")
			.attr("cx", function(d){return d.x;})
			.attr("cy", function(d){return d.y;})
			.attr("r", function(d){return ("_prots" in d)?((d.prots != null)?50:40):30});
		graphSVG.selectAll("text.node")
			.attr("x",function(d){return d.x;})
			.attr("y",function(d){return d.y;});
		if(selectedNet){
			graphSVG.selectAll("circle.selectedNet")
				.attr("cx",selectedNet.x)
				.attr("cy",selectedNet.y)
				.attr("r",60);
		}
		if(selectedPrototype){
			graphSVG.selectAll("circle.selectedPrototype")
				.attr("cx",selectedPrototype.x)
				.attr("cy",selectedPrototype.y)
				.attr("r",40);
		}
	}

	function updateNodeAndLinkArrays() {
		nodes = []; 
		links = [];
		for (var n in nets){
			var s = nodes.length;
			nodes.push(nets[n]);
			for (var p in nets[n].prots){
				var t = nodes.length;
				nodes.push(nets[n].prots[p]);
				links.push({source:s, target:t});
			}
		}
	}

	function updateGraphSVG() {
		graphSVG.selectAll("line.node").remove();
		graphSVG.selectAll("g").remove();
		graphSVG.selectAll("line.node")
			.data(links)
			.enter().append("svg:line")
			.attr("class", "node");
		var ngs = graphSVG.selectAll("circle.node")
			.data(nodes)
			.enter().append("g")
			.on("click", nodeClick);
		ngs.append("svg:circle")
			.attr("class", "node")
		ngs.append("text")
			.attr("class", "node")
			.text(function(d){return d.name;});
	}

	function nodeClick(n){
		// clicked a net
		if("_prots" in n){
			// things that always get updated
			selectedPrototype = null;
			graphSVG.selectAll("circle.selectedPrototype").remove();
			graphSVG.selectAll("circle.selectedNet").remove();

			// close what's open
			if(selectedNet){
				selectedNet._prots = selectedNet.prots;
				selectedNet.prots = null;
			}

			// if only closing, de-select node
			if(n == selectedNet){
				selectedNet = null;
			}
			// else open new
			else{
				graphSVG.append("circle")
					.attr("class","selectedNet");
				selectedNet = n;
				selectedNet.prots = selectedNet._prots;
				selectedNet._prots = null;
			}
		}
		// clicked a prototypes
		else{
			// if already selected, de-select node
			selectedPrototype = (n == selectedPrototype)?null:n;
			if(selectedPrototype){
				graphSVG.append("circle")
					.attr("class","selectedPrototype");
			}
			else{
				graphSVG.selectAll("circle.selectedPrototype").remove();
			}
		}

		// update node arrays
		updateNodeAndLinkArrays();
		// update svg
		updateGraphSVG();
		// update graph
		theForce.nodes(nodes)
			.links(links)
			.start();
	}

    </script>
</body>
</html>
